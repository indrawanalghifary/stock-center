{% extends 'base.html' %}

{% block title %}Riwayat Stock Opname{% endblock %}

{% block content %}
<div class="flex flex-col gap-4 mb-6">
    <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center gap-4">
        <h1 class="text-2xl font-bold">Riwayat Stock Opname</h1>
        <a href="{% url 'stock_opname' %}" class="btn btn-primary">
            <i data-lucide="plus"></i> Stock Opname Baru
        </a>
    </div>

    <!-- Statistics Cards -->
    <div class="stats shadow w-full bg-base-100 border border-base-200">
        <div class="stat">
            <div class="stat-figure text-primary">
                <i data-lucide="check-square" class="w-8 h-8"></i>
            </div>
            <div class="stat-title text-sm opacity-70">Total Opname</div>
            <div class="stat-value text-primary text-2xl">{{ total_opnames }}</div>
            <div class="stat-desc text-xs">Catatan</div>
        </div>
        <div class="stat">
            <div class="stat-figure text-success">
                <i data-lucide="trending-up" class="w-8 h-8"></i>
            </div>
            <div class="stat-title text-sm opacity-70">Surplus (Lebih)</div>
            <div class="stat-value text-success text-2xl">+{{ positive_variance }}</div>
            <div class="stat-desc text-xs">unit</div>
        </div>
        <div class="stat">
            <div class="stat-figure text-error">
                <i data-lucide="trending-down" class="w-8 h-8"></i>
            </div>
            <div class="stat-title text-sm opacity-70">Shortage (Kurang)</div>
            <div class="stat-value text-error text-2xl">{{ negative_variance }}</div>
            <div class="stat-desc text-xs">unit</div>
        </div>
        <div class="stat">
            <div class="stat-figure text-info">
                <i data-lucide="message-square" class="w-8 h-8"></i>
            </div>
            <div class="stat-title text-sm opacity-70">Ada Catatan</div>
            <div class="stat-value text-info text-2xl">{{ opnames_with_notes }}</div>
            <div class="stat-desc text-xs">catatan</div>
        </div>
    </div>

    <!-- Filters -->
    <form method="get" class="bg-base-100 p-4 rounded-box shadow-sm border border-base-200">
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-2 items-end">
            <!-- Search -->
            <div class="form-control lg:col-span-2">
                <label class="label"><span class="label-text-alt">Pencarian</span></label>
                <div class="join w-full">
                    <input type="text" name="q" placeholder="Cari Produk / SKU..." class="input input-bordered join-item w-full" value="{{ request.GET.q|default:'' }}">
                    <button class="btn join-item"><i data-lucide="search"></i></button>
                </div>
            </div>

            <!-- Warehouse Filter -->
            <div class="form-control">
                <label class="label"><span class="label-text-alt">Gudang</span></label>
                <select name="warehouse" class="select select-bordered w-full" onchange="this.form.submit()">
                    <option value="">Semua Gudang</option>
                    {% for w in warehouses %}
                    <option value="{{ w.id }}" {% if request.GET.warehouse == w.id|stringformat:"s" %}selected{% endif %}>{{ w.name }}</option>
                    {% endfor %}
                </select>
            </div>

            <!-- User Filter -->
            <div class="form-control">
                <label class="label"><span class="label-text-alt">Operator</span></label>
                <select name="user" class="select select-bordered w-full" onchange="this.form.submit()">
                    <option value="">Semua Operator</option>
                    {% for u in users %}
                    <option value="{{ u.id }}" {% if request.GET.user == u.id|stringformat:"s" %}selected{% endif %}>{{ u.get_full_name|default:u.username }}</option>
                    {% endfor %}
                </select>
            </div>

            <!-- From Date -->
            <div class="form-control">
                <label class="label"><span class="label-text-alt">Dari Tanggal</span></label>
                <input type="date" name="from_date" class="input input-bordered w-full" value="{{ request.GET.from_date|default:'' }}" onchange="this.form.submit()">
            </div>

            <!-- To Date -->
            <div class="form-control">
                <label class="label"><span class="label-text-alt">Sampai Tanggal</span></label>
                <input type="date" name="to_date" class="input input-bordered w-full" value="{{ request.GET.to_date|default:'' }}" onchange="this.form.submit()">
            </div>
        </div>
    </form>

    <!-- Filtered Statistics -->
    {% if request.GET.q or request.GET.warehouse or request.GET.user or request.GET.from_date or request.GET.to_date %}
    <div class="alert alert-info">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="stroke-current shrink-0 w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
        <div>
            <h3 class="font-bold">Statistik Filter</h3>
            <div class="text-sm">Total: <strong>{{ filtered_count }}</strong> opname | Variance: <strong>{{ filtered_variance }}</strong> unit</div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Table -->
<div class="overflow-x-auto">
    <table class="table w-full">
        <thead>
            <tr>
                <th class="w-32">Tanggal</th>
                <th>Gudang</th>
                <th>Produk / SKU</th>
                <th>Varian</th>
                <th class="text-center">Sebelum</th>
                <th class="text-center">Variance</th>
                <th>Operator</th>
                <th>Catatan</th>
                <th>Aksi</th>
            </tr>
        </thead>
        <tbody>
            {% for movement in movements %}
            <tr class="hover">
                <td class="font-mono text-xs">
                    <div>{{ movement.created_at|date:"d/m/Y" }}</div>
                    <div class="text-gray-500">{{ movement.created_at|time:"H:i" }}</div>
                </td>
                <td>{{ movement.warehouse.name }}</td>
                <td>
                    <div class="font-bold">{{ movement.variant.product.name }}</div>
                    <div class="text-sm opacity-60">{{ movement.variant.sku }}</div>
                </td>
                <td>{{ movement.variant.color }} / {{ movement.variant.size }}</td>
                <td class="text-center font-bold">
                    <span class="badge badge-lg">{{ movement.qty_before|default:"—" }}</span>
                </td>
                <td class="text-center">
                    {% if movement.qty > 0 %}
                        <span class="badge badge-success gap-2">
                            <i data-lucide="arrow-up" class="w-4 h-4"></i>
                            +{{ movement.qty }}
                        </span>
                    {% elif movement.qty < 0 %}
                        <span class="badge badge-error gap-2">
                            <i data-lucide="arrow-down" class="w-4 h-4"></i>
                            {{ movement.qty }}
                        </span>
                    {% else %}
                        <span class="badge">No Change</span>
                    {% endif %}
                </td>
                <td>{{ movement.user.get_full_name|default:movement.user.username }}</td>
                <td>
                    {% if movement.notes %}
                        <div class="text-sm max-w-xs truncate" title="{{ movement.notes }}">
                            <i data-lucide="message-square" class="w-4 h-4 inline"></i>
                            {{ movement.notes }}
                        </div>
                    {% else %}
                        <span class="text-gray-400 text-sm">—</span>
                    {% endif %}
                </td>
                <td>
                    <button type="button" class="btn btn-ghost btn-xs" onclick="showDetails('{{ movement.id }}', '{{ movement.variant.sku }}', '{{ movement.warehouse.name }}', '{{ movement.qty_before }}', '{{ movement.qty }}', `{{ movement.notes|escapejs }}`)">>
                        <i data-lucide="eye" class="w-4 h-4"></i> Detail
                    </button>
                </td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="8" class="text-center py-4">
                    {% if request.GET.q or request.GET.warehouse or request.GET.user or request.GET.from_date or request.GET.to_date %}
                        Tidak ada data opname yang sesuai dengan filter.
                    {% else %}
                        Belum ada riwayat stock opname.
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

{% include 'partials/pagination.html' %}

<!-- Detail Modal -->
<dialog id="detailModal" class="modal">
    <form method="dialog" class="modal-box">
        <button type="submit" class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2">✕</button>
        <h3 class="font-bold text-lg mb-4">Detail Stock Opname</h3>
        
        <div class="space-y-3">
            <div class="form-control">
                <label class="label">
                    <span class="label-text">Produk (SKU)</span>
                </label>
                <input type="text" id="modalSku" class="input input-bordered" readonly>
            </div>

            <div class="form-control">
                <label class="label">
                    <span class="label-text">Gudang</span>
                </label>
                <input type="text" id="modalWarehouse" class="input input-bordered" readonly>
            </div>

            <div class="grid grid-cols-2 gap-2">
                <div class="form-control">
                    <label class="label">
                        <span class="label-text">Stok Sebelum</span>
                    </label>
                    <input type="text" id="modalQtyBefore" class="input input-bordered font-bold" readonly>
                </div>

                <div class="form-control">
                    <label class="label">
                        <span class="label-text">Variance</span>
                    </label>
                    <input type="text" id="modalVariance" class="input input-bordered font-bold" readonly>
                </div>
            </div>

            <div class="form-control">
                <label class="label">
                    <span class="label-text">Catatan</span>
                </label>
                <textarea id="modalNotes" class="textarea textarea-bordered" readonly rows="3"></textarea>
            </div>
        </div>

        <div class="modal-action">
            <button type="submit" class="btn">Tutup</button>
        </div>
    </form>
</dialog>

<script>
    function showDetails(id, sku, warehouse, qtyBefore, variance, notes) {
        document.getElementById('modalSku').value = sku;
        document.getElementById('modalWarehouse').value = warehouse;
        document.getElementById('modalQtyBefore').value = qtyBefore || '—';
        document.getElementById('modalVariance').value = (variance > 0 ? '+' : '') + variance + ' unit';
        document.getElementById('modalNotes').value = notes || '(Tidak ada catatan)';
        document.getElementById('detailModal').showModal();
    }
</script>
{% endblock %}
