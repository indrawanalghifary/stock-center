{% extends 'base.html' %}

{% block title %}Inventory List{% endblock %}

{% block content %}
<div class="flex flex-col gap-4 mb-6">
    <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center gap-4">
        <h1 class="text-2xl font-bold">Stok Gudang</h1>
        <div class="flex gap-2 w-full lg:w-auto">
            <button type="button" onclick="submitBulkBarcode()" class="btn btn-secondary flex-1 lg:flex-none">
                <i data-lucide="barcode"></i> Cetak Barcode
            </button>
            {% if not user.reseller_profile %}
                <a href="{% url 'stock_in' %}" class="btn btn-primary flex-1 lg:flex-none">
                    <i data-lucide="plus"></i> <span class="inline">Tambah Stok</span>
                </a>
            {% endif %}
        </div>
    </div>

    <form method="get" class="bg-base-100 p-4 rounded-box shadow-sm border border-base-200">
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-2 items-end">
            <!-- Search -->
            <div class="form-control lg:col-span-2">
                <label class="label"><span class="label-text-alt">Pencarian</span></label>
                <div class="join w-full">
                    <input type="text" name="q" placeholder="Cari Produk / SKU..." class="input input-bordered join-item w-full" value="{{ request.GET.q|default:'' }}">
                    <button class="btn join-item"><i data-lucide="search"></i></button>
                </div>
            </div>

            <!-- Filters -->
            <div class="form-control">
                <label class="label"><span class="label-text-alt">Gudang</span></label>
                <select name="warehouse" class="select select-bordered w-full" onchange="this.form.submit()">
                    <option value="">Semua Gudang</option>
                    {% for w in warehouses %}
                    <option value="{{ w.id }}" {% if request.GET.warehouse == w.id|stringformat:"s" %}selected{% endif %}>{{ w.name }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="form-control">
                <label class="label"><span class="label-text-alt">Kategori</span></label>
                <select name="category" class="select select-bordered w-full" onchange="this.form.submit()">
                    <option value="">Semua Kategori</option>
                    {% for c in categories %}
                    <option value="{{ c }}" {% if request.GET.category == c %}selected{% endif %}>{{ c }}</option>
                    {% endfor %}
                </select>
            </div>

             <div class="form-control">
                <label class="label"><span class="label-text-alt">Brand</span></label>
                <select name="brand" class="select select-bordered w-full" onchange="this.form.submit()">
                    <option value="">Semua Brand</option>
                    {% for b in brands %}
                    <option value="{{ b }}" {% if request.GET.brand == b %}selected{% endif %}>{{ b }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>
    </form>

    <!-- Summary Card -->
    {% if not user.reseller_profile %}
    <div class="stats shadow w-full bg-base-100 border border-base-200">
        <div class="stat">
            <div class="stat-figure text-primary">
                <i data-lucide="package" class="w-8 h-8"></i>
            </div>
            <div class="stat-title text-sm opacity-70">Total Stok (Sesuai Filter)</div>
            <div class="stat-value text-primary text-2xl">{{ total_qty }}</div>
            <div class="stat-desc text-xs">unit</div>
        </div>
        <div class="stat">
            <div class="stat-figure text-secondary">
                <i data-lucide="banknote" class="w-8 h-8"></i>
            </div>
            <div class="stat-title text-sm opacity-70">Total Nilai Nominal Stok (Sesuai Filter)</div>
            <div class="stat-value text-secondary text-2xl">Rp {{ total_nominal|floatformat:0 }}</div>
            <div class="stat-desc text-xs">Dihitung dari (Stok x Harga Default)</div>
        </div>
    </div>
    {% endif %}
</div>

<div class="overflow-x-auto">
    <form id="bulkForm" action="{% url 'bulk_barcode' %}" method="get">
    <table class="table w-full">
        <thead>
            <tr>
                <th class="w-10">
                    <input type="checkbox" id="selectAll" class="checkbox checkbox-sm">
                </th>
                <th class="w-20 text-center">Qty Cetak</th>
                <th class="cursor-pointer hover:bg-base-200" onclick="sortTable('warehouse')">
                    <div class="flex items-center gap-1">
                        Gudang
                        <span class="text-xs" id="sort-warehouse">{% if request.GET.sort == 'warehouse' and request.GET.order == 'desc' %}↓{% elif request.GET.sort == 'warehouse' %}↑{% else %}⇅{% endif %}</span>
                    </div>
                </th>
                <th class="cursor-pointer hover:bg-base-200" onclick="sortTable('product')">
                    <div class="flex items-center gap-1">
                        Produk
                        <span class="text-xs" id="sort-product">{% if request.GET.sort == 'product' and request.GET.order == 'desc' %}↓{% elif request.GET.sort == 'product' %}↑{% else %}⇅{% endif %}</span>
                    </div>
                </th>
                <th class="cursor-pointer hover:bg-base-200" onclick="sortTable('sku')">
                    <div class="flex items-center gap-1">
                        SKU
                        <span class="text-xs" id="sort-sku">{% if request.GET.sort == 'sku' and request.GET.order == 'desc' %}↓{% elif request.GET.sort == 'sku' %}↑{% else %}⇅{% endif %}</span>
                    </div>
                </th>
                <th class="cursor-pointer hover:bg-base-200" onclick="sortTable('variant')">
                    <div class="flex items-center gap-1">
                        Varian
                        <span class="text-xs" id="sort-variant">{% if request.GET.sort == 'variant' and request.GET.order == 'desc' %}↓{% elif request.GET.sort == 'variant' %}↑{% else %}⇅{% endif %}</span>
                    </div>
                </th>
                <th class="cursor-pointer hover:bg-base-200" onclick="sortTable('stock')">
                    <div class="flex items-center gap-1">
                        Stok
                        <span class="text-xs" id="sort-stock">{% if request.GET.sort == 'stock' and request.GET.order == 'desc' %}↓{% elif request.GET.sort == 'stock' %}↑{% else %}⇅{% endif %}</span>
                    </div>
                </th>
                {% if not user.reseller_profile %}
                <th>Nominal</th>
                {% endif %}
                <th>Aksi</th>
            </tr>
        </thead>
        <tbody>
            {% for stock in stocks %}
            <tr class="hover">
                <td>
                    <input type="checkbox" name="variants" value="{{ stock.variant.id }}" class="checkbox checkbox-sm row-checkbox">
                </td>
                <td class="text-center">
                    <input type="number" name="qty_{{ stock.variant.id }}" value="1" min="1" class="input input-bordered input-xs w-16 qty-input">
                </td>
                <td>{{ stock.warehouse.name }}</td>
                <td class="font-bold">{{ stock.variant.product.name }}</td>
                <td><span class="badge badge-ghost">{{ stock.variant.sku }}</span></td>
                <td>{{ stock.variant.color }} / {{ stock.variant.size }}</td>
                <td>
                    <span class="badge 
                        {% if stock.qty_available < 10 %}
                            badge-error
                        {% elif stock.qty_available < 20 %}
                            badge-warning
                        {% else %}
                            badge-success
                        {% endif %}
                    ">
                        {{ stock.qty_available }}
                    </span>
                </td>
                {% if not user.reseller_profile %}
                <td class="font-mono text-xs whitespace-nowrap">
                    Rp {{ stock.nominal_value|floatformat:0 }}
                </td>
                {% endif %}
                <td>
                    <div class="flex gap-1">
                        <a href="{% url 'variant_detail' stock.variant.pk %}" class="btn btn-ghost btn-xs" title="Detail">
                            <i data-lucide="eye" class="w-4 h-4"></i>
                        </a>
                        <a href="{% url 'variant_barcode' stock.variant.pk %}" class="btn btn-ghost btn-xs text-secondary" title="Barcode">
                            <i data-lucide="barcode" class="w-4 h-4"></i>
                        </a>
                    </div>
                </td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="5" class="text-center py-4">
                    {% if request.GET.q %}
                        Tidak ada stok yang cocok dengan pencarian "{{ request.GET.q }}".
                    {% else %}
                        Belum ada data stok.
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    </form>
</div>

{% include 'partials/pagination.html' %}

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const selectAll = document.getElementById('selectAll');
        const rowCheckboxes = document.querySelectorAll('.row-checkbox');

        if (selectAll) {
            selectAll.addEventListener('change', function() {
                rowCheckboxes.forEach(cb => cb.checked = selectAll.checked);
            });
        }
    });

    function submitBulkBarcode() {
        const selected = document.querySelectorAll('.row-checkbox:checked');
        if (selected.length === 0) {
            alert('Silakan pilih minimal satu item.');
            return;
        }
        document.getElementById('bulkForm').submit();
    }

    function sortTable(column) {
        const currentSort = new URLSearchParams(window.location.search).get('sort');
        const currentOrder = new URLSearchParams(window.location.search).get('order') || 'asc';
        
        // Determine new sort order
        let newOrder = 'asc';
        if (currentSort === column && currentOrder === 'asc') {
            newOrder = 'desc';
        }
        
        // Build new URL with sort parameters
        const url = new URL(window.location);
        url.searchParams.set('sort', column);
        url.searchParams.set('order', newOrder);
        
        // Preserve other filters
        window.location.href = url.toString();
    }
</script>
{% endblock %}