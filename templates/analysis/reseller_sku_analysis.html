{% extends 'base.html' %}
{% load humanize %}

{% block title %}Analisa Pengambilan SKU per Reseller{% endblock %}

{% block content %}
<div class="flex flex-col gap-6">
    <!-- Header & Filter -->
    <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center gap-4">
        <div>
            <h1 class="text-2xl font-bold">üìä Analisa Pengambilan SKU per Reseller</h1>
            <p class="text-sm opacity-70 mt-1">Monitor produk SKU yang diambil oleh masing-masing reseller</p>
        </div>

        <form method="get" class="bg-base-100 p-4 rounded-box shadow-sm border border-base-200 w-full lg:w-auto">
            <div class="flex flex-wrap gap-4 items-end">
                <div class="form-control">
                    <label class="label"><span class="label-text-alt font-bold">Dari</span></label>
                    <input type="date" name="start_date" class="input input-bordered input-sm" value="{{ start_date }}">
                </div>
                <div class="form-control">
                    <label class="label"><span class="label-text-alt font-bold">Sampai</span></label>
                    <input type="date" name="end_date" class="input input-bordered input-sm" value="{{ end_date }}">
                </div>
                <div class="form-control">
                    <label class="label"><span class="label-text-alt font-bold">Reseller</span></label>
                    <select name="reseller_id" class="select select-bordered select-sm w-full max-w-xs">
                        <option value="">Semua Reseller</option>
                        {% for r in resellers %}
                        <option value="{{ r.id }}" {% if selected_reseller_id == r.id %}selected{% endif %}>{{ r.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <button type="submit" class="btn btn-primary btn-sm">Filter</button>
                <a href="{% url 'reseller_sku_analysis' %}" class="btn btn-ghost btn-sm">Reset</a>
            </div>
        </form>
    </div>

    <!-- Summary Cards -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div class="stats shadow bg-primary text-primary-content">
            <div class="stat p-4">
                <div class="stat-title text-primary-content opacity-70">Total Qty Diambil</div>
                <div class="stat-value text-xl">{{ total_qty|floatformat:0|intcomma }}</div>
                <div class="stat-desc text-primary-content opacity-70">Periode terpilih</div>
            </div>
        </div>

        {% if user.is_staff %}
        <div class="stats shadow bg-base-100">
            <div class="stat p-4">
                <div class="stat-title opacity-70">Total Nominal</div>
                <div class="stat-value text-xl text-secondary">Rp {{ total_nominal|floatformat:0|intcomma }}</div>
                <div class="stat-desc">Nilai transaksi</div>
            </div>
        </div>
        {% endif %}

        <div class="stats shadow bg-base-100">
            <div class="stat p-4">
                <div class="stat-title opacity-70">Jumlah Reseller Aktif</div>
                <div class="stat-value text-xl text-accent">{{ reseller_summary|length }}</div>
                <div class="stat-desc">Dengan pengambilan</div>
            </div>
        </div>
    </div>

    <!-- Top 10 SKUs -->
    <div class="card bg-base-100 shadow-sm border border-base-200">
        <div class="card-body p-4">
            <div class="flex justify-between items-center mb-2">
                <h3 class="card-title text-sm opacity-70 uppercase text-primary">üèÜ Top 10 SKU Paling Diambil</h3>
                <div class="badge badge-primary badge-sm">Berdasarkan Qty</div>
            </div>
            <div class="overflow-x-auto">
                <table class="table table-sm w-full">
                    <thead>
                        <tr class="bg-base-200">
                            <th class="w-12">Rank</th>
                            <th>SKU</th>
                            <th>Produk</th>
                            <th>Kategori</th>
                            <th class="text-center">Reseller</th>
                            <th class="text-right">Qty</th>
                            {% if user.is_staff %}<th class="text-right">Total Nilai</th>{% endif %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for sku in top_skus %}
                        <tr class="hover {% if forloop.counter <= 3 %}bg-primary/5{% endif %}">
                            <td class="text-center">
                                {% if forloop.counter == 1 %}ü•á
                                {% elif forloop.counter == 2 %}ü•à
                                {% elif forloop.counter == 3 %}ü•â
                                {% else %}{{ forloop.counter }}{% endif %}
                            </td>
                            <td>
                                <div class="font-mono text-xs font-bold">{{ sku.variant__sku }}</div>
                            </td>
                            <td class="font-bold">{{ sku.variant__product__name }}</td>
                            <td>{{ sku.variant__product__category }}</td>
                            <td class="text-center">
                                <div class="badge badge-ghost badge-sm">{{ sku.reseller_count }} reseller</div>
                            </td>
                            <td class="text-right font-mono font-bold text-primary">{{ sku.total_qty }}</td>
                            {% if user.is_staff %}<td class="text-right">Rp {{ sku.total_nominal|floatformat:0|intcomma }}</td>{% endif %}
                        </tr>
                        {% empty %}
                        <tr><td colspan="{% if user.is_staff %}7{% else %}6{% endif %}" class="text-center py-4 opacity-50">Tidak ada data SKU</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Reseller Summary Table -->
    <div class="card bg-base-100 shadow-sm border border-base-200">
        <div class="card-body p-4">
            <div class="flex justify-between items-center mb-2">
                <h3 class="card-title text-sm opacity-70 uppercase text-secondary">üìã Ringkasan Pengambilan per Reseller</h3>
                <div class="badge badge-secondary badge-sm">{{ reseller_summary|length }} Reseller</div>
            </div>
            <div class="overflow-x-auto">
                <table class="table table-sm w-full">
                    <thead>
                        <tr class="bg-base-200">
                            <th class="w-12">Rank</th>
                            <th>Reseller</th>
                            <th class="text-right">Total Qty</th>
                            {% if user.is_staff %}<th class="text-right">Total Nominal</th>{% endif %}
                            <th class="text-center">Aksi</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for r in reseller_summary %}
                        <tr class="hover {% if forloop.counter <= 3 %}bg-secondary/5{% endif %}">
                            <td class="text-center">
                                {% if forloop.counter == 1 %}ü•á
                                {% elif forloop.counter == 2 %}ü•à
                                {% elif forloop.counter == 3 %}ü•â
                                {% else %}{{ forloop.counter }}{% endif %}
                            </td>
                            <td class="font-bold">{{ r.transaction__reseller__name }}</td>
                            <td class="text-right font-mono font-bold">{{ r.total_qty }}</td>
                            {% if user.is_staff %}<td class="text-right font-bold text-secondary">Rp {{ r.total_nominal|floatformat:0|intcomma }}</td>{% endif %}
                            <td class="text-center">
                                <a href="?reseller_id={{ r.transaction__reseller__id }}{% if start_date %}&start_date={{ start_date }}{% endif %}{% if end_date %}&end_date={{ end_date }}{% endif %}" 
                                   class="btn btn-xs btn-ghost">
                                    <i data-lucide="eye"></i> Detail
                                </a>
                            </td>
                        </tr>
                        {% empty %}
                        <tr><td colspan="{% if user.is_staff %}5{% else %}4{% endif %}" class="text-center py-4 opacity-50">Tidak ada data reseller</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Detailed SKU by Reseller Table -->
    <div class="card bg-base-100 shadow-sm border border-base-200">
        <div class="card-body p-4">
            <div class="flex justify-between items-center mb-2">
                <h3 class="card-title text-sm opacity-70 uppercase text-accent">üì¶ Detail SKU yang Diambil per Reseller</h3>
                <div class="badge badge-accent badge-sm">{{ sku_by_reseller|length }} Record</div>
            </div>
            <div class="overflow-x-auto max-h-[600px]">
                <table class="table table-sm w-full table-pin-rows">
                    <thead>
                        <tr class="bg-base-200 sticky top-0">
                            <th>Reseller</th>
                            <th>SKU</th>
                            <th>Produk</th>
                            <th class="text-right">Qty</th>
                            {% if user.is_staff %}<th class="text-right">Harga Avg</th>{% endif %}
                            {% if user.is_staff %}<th class="text-right">Total Nilai</th>{% endif %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in sku_by_reseller %}
                        <tr class="hover">
                            <td class="font-bold">{{ item.transaction__reseller__name }}</td>
                            <td>
                                <div class="font-mono text-xs font-bold">{{ item.variant__sku }}</div>
                            </td>
                            <td>{{ item.variant__product__name }}</td>
                            <td class="text-right font-mono font-bold">{{ item.total_qty }}</td>
                            {% if user.is_staff %}<td class="text-right">Rp {{ item.avg_price|floatformat:0|intcomma }}</td>{% endif %}
                            {% if user.is_staff %}<td class="text-right font-bold text-accent">Rp {{ item.total_nominal|floatformat:0|intcomma }}</td>{% endif %}
                        </tr>
                        {% empty %}
                        <tr><td colspan="{% if user.is_staff %}6{% else %}4{% endif %}" class="text-center py-4 opacity-50">Tidak ada data pengambilan</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        lucide.createIcons();
    });
</script>
{% endblock %}
